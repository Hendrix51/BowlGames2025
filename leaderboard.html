<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <style>
    html { height: 100%; }

    html::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("assets/kick6.webp");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -2;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(246, 247, 251, 0.85);
      z-index: -1;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      margin: 0;
      color: #111;
      min-height: 100svh;
      background: transparent;
    }

    @media (max-width: 768px) {
      html::before { background-position: center top; }
    }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.06); }

    h1 { margin: 0 0 10px; }
    .muted { opacity:.7; font-size: 12px; margin: 0 0 14px; }

    /* Tabs */
    .tabs {
      display:flex;
      gap:10px;
      margin: 8px 0 16px;
      flex-wrap: wrap;

      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
      background: rgba(246,247,251,0.65);
      backdrop-filter: blur(6px);
    }

    .tabbtn{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      font-weight: 800;
    }
    .tabbtn.active { background:#111; color:#fff; border-color:#111; }

    /* Leaderboard table */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th { font-size:12px; opacity:.7; text-transform:uppercase; letter-spacing:.04em; }
    .wins { text-align:right; }

    /* Picks grid */
    .gridWrap {
      overflow: auto;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .swipeHint {
      display: none;
      margin: 0 0 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.85);
      border: 1px solid rgba(0,0,0,0.06);
      font-size: 12px;
      opacity: .8;
    }
    @media (max-width: 768px) {
      .swipeHint { display: block; }
    }

    .picksGrid {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: rgba(255,255,255,0.92);
    }

    .picksGrid th, .picksGrid td {
      border: 1px solid rgba(0,0,0,0.06);
      padding: 8px 10px;
      vertical-align: top;
      white-space: nowrap;
    }

    .picksGrid thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(255,255,255,0.98);
      font-weight: 900;
    }

    .picksGrid .matchupCol {
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(255,255,255,0.98);
      font-weight: 900;
      min-width: 260px;
      max-width: 360px;

      white-space: normal !important;
      line-height: 1.15;
      overflow-wrap: anywhere;
    }

    @media (max-width: 768px) {
      .picksGrid .matchupCol {
        min-width: 140px;
        max-width: 180px;
      }
    }

    @media (max-width: 480px) {
      .picksGrid .matchupCol { position: static; }
    }

    .cell {
      border-radius: 10px;
      padding: 6px 8px;
      display: inline-block;
      line-height: 1.2;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cell.win { background: rgba(10,122,47,0.16); }
    .cell.loss { background: rgba(176,0,32,0.14); }
    .cell.pending { background: rgba(120,120,120,0.10); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>College Football Bowl Pick’em 2025</h1>

      <div class="tabs">
        <button id="tabLeaderboard" class="tabbtn active">Leaderboard</button>
        <button id="tabPicks" class="tabbtn">Picks Grid</button>
      </div>

      <!-- Leaderboard view -->
      <div id="viewLeaderboard">
        <div id="status">Loading…</div>
        <table id="tbl" style="display:none">
          <thead>
            <tr><th>#</th><th>Name</th><th class="wins">Wins</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Picks grid view -->
      <div id="viewPicks" style="display:none;">
        <div id="picksStatus" class="muted">Click “Picks Grid” to load…</div>
        <div class="swipeHint">Swipe left/right to see everyone’s picks →</div>

        <div class="gridWrap">
          <table class="picksGrid" id="picksGrid" style="display:none;">
            <thead id="picksHead"></thead>
            <tbody id="picksBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDZv4jHUdu7t7crWX4-3GToFzvHKofDSfNANUrVyGCs0Igb3HPYWw8liHOEoIZGHKmnA/exec";

    // ✅ Auto-unlock Picks Grid at Tue Dec 16 2025, 9:00 PM ET
    const UNLOCK_AT_ET = new Date("2025-12-16T21:00:00-05:00").getTime();
    const PICKS_GRID_UNLOCKED = () => Date.now() >= UNLOCK_AT_ET;

    // ✅ Hide the “last 4” games until a DIFFERENT time (example: Jan 1, 2026 12:00 PM ET)
    const FINAL4_REVEAL_AT_ET = new Date("2025-12-31T19:30:00-05:00").getTime();

    // Put the IDs of the games you want hidden until FINAL4_REVEAL_AT_ET
    const FINAL4_GAME_IDS = new Set([
        "Cotton-bowl-2025-12-31",
        "Orange-bowl-2026-01-01",
        "Rose-bowl-2026-01-01",
        "Sugar-bowl-2026-01-01"
    ]);

    function isGameRevealed(gid) {
    if (!FINAL4_GAME_IDS.has(String(gid))) return true;
    return Date.now() >= FINAL4_REVEAL_AT_ET;
    }

    const GAMES = [
        { id: "salute-to-veterans-2025-12-16", date: "Dec 16, 2025", bowl: "IS4S Salute to Veterans Bowl",
          team1: "Troy", team2: "Jacksonville State", spread1: "-2.5", spread2: "+2.5" },

        { id: "cure-bowl-2025-12-17", date: "Dec 17, 2025", bowl: "StaffDNA Cure Bowl",
           team1: "Old Dominion", team2: "USF", spread1: "+3.5", spread2: "-3.5" },

        { id: "68-ventures-bowl-2025-12-17", date: "Dec 17, 2025", bowl: "68 Ventures Bowl",
          team1: "Louisiana", team2: "Delaware", spread1: "-3", spread2: "+3" },

        { id: "xbox-bowl-2025-12-18", date: "Dec 18, 2025", bowl: "Xbox Bowl",
           team1: "Missouri State", team2: "Arkansas State", spread1: "+1.5", spread2: "-1.5" },

        { id: "myrtle-beach-bowl-2025-12-19", date: "Dec 19, 2025", bowl: "Myrtle Beach Bowl",
          team1: "Kennesaw State", team2: "Western Michigan", spread1: "+3.5", spread2: "-3.5" },

        { id: "gasparilla-bowl-2025-12-19", date: "Dec 19, 2025", bowl: "Union Home Mortgage Gasparilla Bowl",
           team1: "Memphis", team2: "NC State", spread1: "+5.5", spread2: "-5.5" },

        { id: "cfp-first-round-1-2025-12-19", date: "Dec 19, 2025", bowl: "CFP First Round",
           team1: "Alabama", team2: "Oklahoma", spread1: "-1.5", spread2: "+1.5" },

        { id: "cfp-first-round-2-2025-12-20", date: "Dec 20, 2025", bowl: "CFP First Round",
           team1: "Miami (FL)", team2: "Texas A&M", spread1: "+3.5", spread2: "-3.5" },

        { id: "cfp-first-round-3-2025-12-20", date: "Dec 20, 2025", bowl: "CFP First Round",
           team1: "Tulane", team2: "Ole Miss", spread1: "+17.5", spread2: "-17.5" },

        { id: "cfp-first-round-4-2025-12-20", date: "Dec 20, 2025", bowl: "CFP First Round",
           team1: "James Madison", team2: "Oregon", spread1: "+21.5", spread2: "-21.5" },

        { id: "potato-bowl-2025-12-22", date: "Dec 22, 2025", bowl: "Famous Idaho Potato Bowl",
          team1: "Washington State", team2: "Utah State", spread1: "+3", spread2: "-3" },

        { id: "boca-raton-bowl-2025-12-23", date: "Dec 23, 2025", bowl: "Bush's Boca Raton Bowl of Beans",
          team1: "Toledo", team2: "Louisville", spread1: "+8.5", spread2: "-8.5" },

        { id: "new-orleans-bowl-2025-12-23", date: "Dec 23, 2025", bowl: "New Orleans Bowl",
           team1: "WKU", team2: "Southern Miss", spread1: "-4", spread2: "+4" },

        { id: "frisco-bowl-2025-12-23", date: "Dec 23, 2025", bowl: "Scooter's Coffee Frisco Bowl",
          team1: "UNLV", team2: "Ohio", spread1: "-4.5", spread2: "+4.5" },

        { id: "hawaii-bowl-2025-12-24", date: "Dec 24, 2025", bowl: "Sheraton Hawai'i Bowl",
           team1: "California", team2: "Hawai'i", spread1: "-1.5", spread2: "+1.5" },

        { id: "gameabove-sports-bowl-2025-12-26", date: "Dec 26, 2025", bowl: "GameAbove Sports Bowl",
           team1: "Central Michigan", team2: "Northwestern", spread1: "+10.5", spread2: "-10.5" },

        { id: "rate-bowl-2025-12-26", date: "Dec 26, 2025", bowl: "Rate Bowl",
           team1: "New Mexico", team2: "Minnesota", spread1: "+2.5", spread2: "-2.5" },

        { id: "first-responder-bowl-2025-12-26", date: "Dec 26, 2025", bowl: "SERVPRO First Responder Bowl",
           team1: "FIU", team2: "UTSA", spread1: "+8.5", spread2: "-8.5" },

        { id: "military-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Go Bowling Military Bowl",
           team1: "Pitt", team2: "East Carolina", spread1: "-4", spread2: "+4" },

        { id: "pinstripe-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Bad Boy Mowers Pinstripe Bowl",
          team1: "Penn State", team2: "Clemson", spread1: "+4.5", spread2: "-4.5" },

        { id: "fenway-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Wasabi Fenway Bowl",
           team1: "UConn", team2: "Army", spread1: "+7", spread2: "-7" },

        { id: "poptarts-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Pop-Tarts Bowl",
           team1: "Georgia Tech", team2: "BYU", spread1: "+4.5", spread2: "-4.5" },

        { id: "arizona-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Snoop Dogg Arizona Bowl",
           team1: "Miami (OH)", team2: "Fresno State", spread1: "+3.5", spread2: "-3.5" },

        { id: "new-mexico-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Isleta New Mexico Bowl",
           team1: "North Texas", team2: "San Diego State", spread1: "-3", spread2: "+3" },

        { id: "gator-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "TaxSlayer Gator Bowl",
           team1: "Virginia", team2: "Missouri", spread1: "+7", spread2: "-7" },

        { id: "texas-bowl-2025-12-27", date: "Dec 27, 2025", bowl: "Kinder's Texas Bowl",
          team1: "LSU", team2: "Houston", spread1: "+3", spread2: "-3" },

        { id: "birmingham-bowl-2025-12-29", date: "Dec 29, 2025", bowl: "JLab Birmingham Bowl",
           team1: "Georgia Southern", team2: "App State", spread1: "-4", spread2: "+4" },

        { id: "independence-bowl-2025-12-30", date: "Dec 30, 2025", bowl: "Radiance Tech Independence Bowl",
          team1: "Coastal Carolina", team2: "Louisiana Tech", spread1: "+8.5", spread2: "-8.5" },

        { id: "music-city-bowl-2025-12-30", date: "Dec 30, 2025", bowl: "Liberty Mutual Music City Bowl",
           team1: "Tennessee", team2: "Illinois", spread1: "-4", spread2: "+4" },

        { id: "alamo-bowl-2025-12-30", date: "Dec 30, 2025", bowl: "Valero Alamo Bowl",
           team1: "USC", team2: "TCU", spread1: "-6", spread2: "+6" },

        { id: "reliaquest-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "ReliaQuest Bowl",
           team1: "Iowa", team2: "Vanderbilt", spread1: "+6", spread2: "-6" },

        { id: "sun-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "Tony the Tiger Sun Bowl",
           team1: "Arizona State", team2: "Duke", spread1: "+3", spread2: "-3" },

        { id: "citrus-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "Cheez-It Citrus Bowl",
           team1: "Michigan", team2: "Texas", spread1: "+7.5", spread2: "-7.5" },

        { id: "las-vegas-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "SRS Distribution Las Vegas Bowl",
          team1: "Nebraska", team2: "Utah", spread1: "+16.5", spread2: "-16.5" },

        { id: "armed-forces-bowl-2026-01-02", date: "Jan 2, 2026", bowl: "Lockheed Martin Armed Forces Bowl",
           team1: "Rice", team2: "Texas State", spread1: "+10", spread2: "-10" },

        { id: "liberty-bowl-2026-01-02", date: "Jan 2, 2026", bowl: "AutoZone Liberty Bowl",
           team1: "Navy", team2: "Cincinnati", spread1: "-4.5", spread2: "+4.5" },

        { id: "dukes-mayo-bowl-2026-01-02", date: "Jan 2, 2026", bowl: "Duke's Mayo Bowl",
           team1: "Wake Forest", team2: "Mississippi State", spread1: "+2.5", spread2: "-2.5" },

        { id: "holiday-bowl-2026-01-02", date: "Jan 2, 2026", bowl: "Trust & Will Holiday Bowl",
           team1: "Arizona", team2: "SMU", spread1: "-3", spread2: "+3" },
        
        { id: "Cotton-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "Cotton Bowl",
           team1: "Miami (FL)", team2: "Ohio State", spread1: "+10", spread2: "-10" },

        { id: "Orange-bowl-2026-01-01", date: "Jan 1, 2026", bowl: "Orange Bowl",
           team1: "Oregon", team2: "Texas Tech", spread1: "-1.5", spread2: "+1.5" },
           
        { id: "Rose-bowl-2026-01-01", date: "Jan 1, 2026", bowl: "Rose Holiday Bowl",
           team1: "Alabama", team2: "Indiana", spread1: "+7", spread2: "-7" },
           
        { id: "Sugar-bowl-2026-01-01", date: "Dec 1, 2026", bowl: "Sugar Bowl",
           team1: "Ole Miss", team2: "UGA", spread1: "+7", spread2: "-7" },    
    ];

    const GAME_MAP = Object.fromEntries(
        GAMES.map(g => [
            g.id,
            `${g.team1}${g.spread1 ? " (" + g.spread1 + ")" : ""} vs ${g.team2}${g.spread2 ? " (" + g.spread2 + ")" : ""}`
        ])
    );

    let picksLoaded = false;

    function setActiveTab(which) {
      const tL = document.getElementById("tabLeaderboard");
      const tP = document.getElementById("tabPicks");
      const vL = document.getElementById("viewLeaderboard");
      const vP = document.getElementById("viewPicks");

      const isL = which === "leaderboard";
      tL.classList.toggle("active", isL);
      tP.classList.toggle("active", !isL);
      vL.style.display = isL ? "" : "none";
      vP.style.display = isL ? "none" : "";

      if (!isL && !picksLoaded) {
        picksLoaded = true;
        document.getElementById("picksStatus").textContent = "Loading picks…";
        loadPicksGrid();
      }
    }

    document.getElementById("tabLeaderboard").addEventListener("click", () => setActiveTab("leaderboard"));

    // ✅ Visible but not reachable until unlock time
    document.getElementById("tabPicks").addEventListener("click", () => {
      if (!PICKS_GRID_UNLOCKED()) {
        alert("Picks grid will unlock when the first games start on Dec 16 at 9:00 PM ET.");
        return;
      }
      setActiveTab("picks");
    });

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    async function loadLeaderboard() {
      const res = await fetch(`${SCRIPT_URL}?action=leaderboard`);
      const data = await res.json();

      if (!data.ok) {
        document.getElementById("status").textContent = data.error || "Failed to load";
        return;
      }

      document.getElementById("rows").innerHTML =
        data.rows.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(r.name)}</td>
            <td class="wins">${r.wins}</td>
          </tr>
        `).join("");

      document.getElementById("status").style.display = "none";
      document.getElementById("tbl").style.display = "";
    }

    async function loadPicksGrid() {
      const picksStatus = document.getElementById("picksStatus");
      const grid = document.getElementById("picksGrid");

      const res = await fetch(`${SCRIPT_URL}?action=picks`);
      const data = await res.json();

      if (!data.ok) {
        picksStatus.textContent = data.error || "Failed to load picks";
        return;
      }

      //const gameIds = data.gameIds || [];

      //for second round update
      const allGameIds = data.gameIds || [];
      const gameIds = allGameIds.filter(isGameRevealed);

      const winners = data.winners || {};
      const users = data.users || [];
      const userPicks = data.userPicks || {};

      if (!users.length) {
        picksStatus.textContent = "No submissions yet.";
        return;
      }
      if (!gameIds.length) {
        picksStatus.textContent = "No game IDs found. Make sure Results sheet has game_id values in column A.";
        return;
      }

      const head = document.getElementById("picksHead");
      head.innerHTML = `
        <tr>
          <th class="matchupCol">Matchup</th>
          ${users.map(u => `<th title="${escapeHtml(u)}">${escapeHtml(u)}</th>`).join("")}
        </tr>
      `;

      const body = document.getElementById("picksBody");
      body.innerHTML = gameIds.map(gid => {
        const matchup = GAME_MAP[gid] || gid;

        const tds = users.map(name => {
          const picksObj = userPicks[name] || {};
          const pick = picksObj[gid] || "";
          const winner = winners[gid];

          let cls = "pending";
          let title = "Pending";
          if (winner) {
            if (pick && String(pick) === String(winner)) {
              cls = "win";
              title = "WIN — Winner: " + winner;
            } else {
              cls = "loss";
              title = "LOSS — Winner: " + winner;
            }
          }

          const text = pick ? pick : "—";
          return `<td><span class="cell ${cls}" title="${escapeHtml(title)}">${escapeHtml(text)}</span></td>`;
        }).join("");

        return `
          <tr>
            <td class="matchupCol" title="${escapeHtml(gid)}">${escapeHtml(matchup)}</td>
            ${tds}
          </tr>
        `;
      }).join("");

      picksStatus.textContent = "";
      grid.style.display = "";
    }

    // Boot
    loadLeaderboard(); // picks loads only after unlock + click
  </script>
</body>
</html>
