<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <style>
    html { height: 100%; }

    html::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("assets/kick6.webp");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -2;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(246, 247, 251, 0.85);
      z-index: -1;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      margin: 0;
      color: #111;
      min-height: 100svh;
      background: transparent;
    }

    @media (max-width: 768px) {
      html::before { background-position: center top; }
    }

    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.06); }

    h1 { margin: 0 0 10px; }
    .muted { opacity:.7; font-size: 12px; margin: 0 0 14px; }

    /* Tabs */
    .tabs { display:flex; gap:10px; margin: 8px 0 16px; flex-wrap: wrap; }
    .tabbtn{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      font-weight: 800;
    }
    .tabbtn.active { background:#111; color:#fff; border-color:#111; }

    /* Leaderboard table */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th { font-size:12px; opacity:.7; text-transform:uppercase; letter-spacing:.04em; }
    .wins { text-align:right; }

    /* Picks grid */
    .gridWrap {
      overflow: auto;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .picksGrid {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: rgba(255,255,255,0.92);
    }

    .picksGrid th, .picksGrid td {
      border: 1px solid rgba(0,0,0,0.06);
      padding: 8px 10px;
      vertical-align: top;
      white-space: nowrap;
    }

    .picksGrid thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(255,255,255,0.98);
      font-weight: 900;
    }

    .picksGrid .nameCol {
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(255,255,255,0.98);
      font-weight: 900;
      min-width: 160px;
    }

    .cell {
      border-radius: 10px;
      padding: 6px 8px;
      display: inline-block;
      line-height: 1.2;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cell.win { background: rgba(10,122,47,0.16); }
    .cell.loss { background: rgba(176,0,32,0.14); }
    .cell.pending { background: rgba(120,120,120,0.10); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>College Football Bowl Pick’em 2025</h1>
      <p class="muted">Leaderboard + everyone’s picks (green = correct, red = wrong, gray = pending)</p>

      <div class="tabs">
        <button id="tabLeaderboard" class="tabbtn active">Leaderboard</button>
        <button id="tabPicks" class="tabbtn">Picks Grid</button>
      </div>

      <!-- Leaderboard view -->
      <div id="viewLeaderboard">
        <div id="status">Loading…</div>
        <table id="tbl" style="display:none">
          <thead>
            <tr><th>#</th><th>Name</th><th class="wins">Wins</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <!-- Picks grid view -->
      <div id="viewPicks" style="display:none;">
        <div id="picksStatus" class="muted">Loading picks…</div>
        <div class="gridWrap">
          <table class="picksGrid" id="picksGrid" style="display:none;">
            <thead id="picksHead"></thead>
            <tbody id="picksBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDZv4jHUdu7t7crWX4-3GToFzvHKofDSfNANUrVyGCs0Igb3HPYWw8liHOEoIZGHKmnA/exec";

    // Tabs
    function setActiveTab(which) {
      const tL = document.getElementById("tabLeaderboard");
      const tP = document.getElementById("tabPicks");
      const vL = document.getElementById("viewLeaderboard");
      const vP = document.getElementById("viewPicks");

      const isL = which === "leaderboard";
      tL.classList.toggle("active", isL);
      tP.classList.toggle("active", !isL);
      vL.style.display = isL ? "" : "none";
      vP.style.display = isL ? "none" : "";
    }

    document.getElementById("tabLeaderboard").addEventListener("click", () => setActiveTab("leaderboard"));
    document.getElementById("tabPicks").addEventListener("click", () => setActiveTab("picks"));

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // Make headers shorter so the grid isn't insane
    function shortId(gid) {
      return gid
        .replace(/-\d{4}-\d{2}-\d{2}$/, "")   // drop date suffix
        .replace(/-bowl$/, "")                // drop trailing -bowl
        .replace(/^cfp-/, "cfp-");            // keep CFP prefix as-is
    }

    async function loadLeaderboard() {
      const res = await fetch(`${SCRIPT_URL}?action=leaderboard`);
      const data = await res.json();

      if (!data.ok) {
        document.getElementById("status").textContent = data.error || "Failed to load";
        return;
      }

      document.getElementById("rows").innerHTML =
        data.rows.map((r, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(r.name)}</td>
            <td class="wins">${r.wins}</td>
          </tr>
        `).join("");

      document.getElementById("status").style.display = "none";
      document.getElementById("tbl").style.display = "";
    }

    async function loadPicksGrid() {
      const picksStatus = document.getElementById("picksStatus");
      const grid = document.getElementById("picksGrid");

      const res = await fetch(`${SCRIPT_URL}?action=picks`);
      const data = await res.json();

      if (!data.ok) {
        picksStatus.textContent = data.error || "Failed to load picks";
        return;
      }

      const gameIds = data.gameIds || [];
      const winners = data.winners || {};
      const users = data.users || [];
      const userPicks = data.userPicks || {};

      if (!users.length) {
        picksStatus.textContent = "No submissions yet.";
        return;
      }
      if (!gameIds.length) {
        picksStatus.textContent = "No game IDs found. Make sure Results sheet has game_id values in column A.";
        return;
      }

      // Header
      const head = document.getElementById("picksHead");
      head.innerHTML = `
        <tr>
          <th class="nameCol">Name</th>
          ${gameIds.map(gid => `
            <th title="${escapeHtml(gid)}">${escapeHtml(shortId(gid))}</th>
          `).join("")}
        </tr>
      `;

      // Body
      const body = document.getElementById("picksBody");
      body.innerHTML = users.map(name => {
        const picksObj = userPicks[name] || {};
        const tds = gameIds.map(gid => {
          const pick = picksObj[gid] || "";
          const winner = winners[gid];

          let cls = "pending";
          let title = "Pending";
          if (winner) {
            if (pick && String(pick) === String(winner)) {
              cls = "win";
              title = "WIN — Winner: " + winner;
            } else {
              cls = "loss";
              title = "LOSS — Winner: " + winner;
            }
          }

          const text = pick ? pick : "—";
          return `<td><span class="cell ${cls}" title="${escapeHtml(title)}">${escapeHtml(text)}</span></td>`;
        }).join("");

        return `<tr><td class="nameCol">${escapeHtml(name)}</td>${tds}</tr>`;
      }).join("");

      picksStatus.textContent = "";
      grid.style.display = "";
    }

    // Boot
    loadLeaderboard();
    loadPicksGrid();
  </script>
</body>
</html>
