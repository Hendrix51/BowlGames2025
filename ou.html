<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>O/U Grid & Leaderboard</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin-bottom: 14px; }
    h1 { margin:0 0 10px; font-size: 22px; }
    .sub { margin: 0 0 12px; opacity: .75; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    a.btn { display:inline-block; padding:8px 12px; border-radius:10px; background:#111; color:#fff; text-decoration:none; font-weight:700; }
    table { width:100%; border-collapse: collapse; font-size: 12px; }
    th, td { border:1px solid #e6e6e6; padding:8px; vertical-align: top; }
    th { position: sticky; top: 0; background: #fff; z-index: 2; }
    .namecol { position: sticky; left: 0; background:#fff; z-index:3; font-weight:700; }
    .muted { opacity:.7; }
    .ok { color:#0a7a2f; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Over/Under Grid</h1>
          <p class="sub">Everyone’s O/U predictions by game. Leaderboard = lowest total absolute error once actual totals are entered.</p>
        </div>
        <div class="row">
          <a class="btn" href="index.html">Back to Picks</a>
          <a class="btn" href="leaderboard.html">Spread Leaderboard</a>
        </div>
      </div>
      <div id="status" class="muted">Loading…</div>
    </div>

    <div class="card">
      <h1>O/U Leaderboard</h1>
      <div id="ouLeaderboard"></div>
    </div>

    <div class="card">
      <h1>O/U Picks Grid</h1>
      <div style="overflow:auto;">
        <table id="grid"></table>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDZv4jHUdu7t7crWX4-3GToFzvHKofDSfNANUrVyGCs0Igb3HPYWw8liHOEoIZGHKmnA/exec";

    const elStatus = document.getElementById("status");
    const elGrid = document.getElementById("grid");
    const elLb = document.getElementById("ouLeaderboard");

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function fmtNum(x) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      return Number.isFinite(n) ? (Math.round(n * 10) / 10).toString() : "";
    }

    async function load() {
      try {
        // Apps Script endpoints:
        //  - ?action=ou_grid -> { ok, gameIds, totals, users, userOUPicks }
        //  - ?action=ou_leaderboard -> { ok, rows: [{name,totalError}, ...] }
        const [gridRes, lbRes] = await Promise.all([
          fetch(SCRIPT_URL + "?action=ou_grid", { method: "GET" }),
          fetch(SCRIPT_URL + "?action=ou_leaderboard", { method: "GET" })
        ]);

        const gridData = await gridRes.json();
        const lbData = await lbRes.json();

        if (!gridData.ok) throw new Error(gridData.error || "Failed to load O/U grid");
        if (!lbData.ok) throw new Error(lbData.error || "Failed to load O/U leaderboard");

        const hasResults = gridData.totals && Object.keys(gridData.totals).length > 0;

        elStatus.textContent = hasResults
          ? "Results detected — leaderboard uses total absolute error."
          : "No results entered yet — add actual totals in the OU_Results tab to populate leaderboard.";

        renderLeaderboard(lbData.rows || []);
        renderGrid(gridData.gameIds || [], gridData.users || [], gridData.userOUPicks || {}, gridData.totals || {});
      } catch (e) {
        elStatus.textContent = "Error: " + e.message;
      }
    }

    function renderLeaderboard(rows) {
      if (!rows.length) {
        elLb.innerHTML = `<div class="muted">No leaderboard yet (results not entered).</div>`;
        return;
      }

      elLb.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Total Error</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, i) => `
              <tr>
                <td>${i + 1}</td>
                <td><strong>${escapeHtml(r.name)}</strong></td>
                <td>${escapeHtml(fmtNum(r.totalError))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderGrid(gameIds, users, userOUPicks, totals) {
      // Header row
      const thead = `
        <thead>
          <tr>
            <th class="namecol">Name</th>
            ${gameIds.map(gid => {
              const actual = totals && Object.prototype.hasOwnProperty.call(totals, gid) ? totals[gid] : undefined;
              const actualTxt = (actual !== undefined)
                ? `<div class="muted">Actual: ${escapeHtml(fmtNum(actual))}</div>`
                : `<div class="muted">Actual: —</div>`;
              return `
                <th>
                  <div><strong>${escapeHtml(gid)}</strong></div>
                  ${actualTxt}
                </th>
              `;
            }).join("")}
          </tr>
        </thead>
      `;

      // Body rows
      const tbody = `
        <tbody>
          ${users.map(name => {
            const picksObj = userOUPicks && userOUPicks[name] ? userOUPicks[name] : {};
            return `
              <tr>
                <td class="namecol">${escapeHtml(name)}</td>
                ${gameIds.map(gid => {
                  const pick = picksObj ? picksObj[gid] : undefined;
                  const actual = totals && Object.prototype.hasOwnProperty.call(totals, gid) ? totals[gid] : undefined;

                  let extra = "";
                  if (actual !== undefined && pick !== undefined && pick !== null && pick !== "") {
                    const diff = Math.abs(Number(pick) - Number(actual));
                    if (Number.isFinite(diff)) extra = `<div class="muted">Δ ${escapeHtml(fmtNum(diff))}</div>`;
                  }

                  return `
                    <td>
                      <div><strong>${escapeHtml(fmtNum(pick))}</strong></div>
                      ${extra}
                    </td>
                  `;
                }).join("")}
              </tr>
            `;
          }).join("")}
        </tbody>
      `;

      elGrid.innerHTML = thead + tbody;

      // Helpful empty-state
      if (!gameIds.length) {
        elGrid.innerHTML = `
          <tbody>
            <tr>
              <td class="muted">
                No games found for O/U yet.
                Add your game IDs to the <strong>OU_Results</strong> sheet (column A, header <code>game_id</code>).
              </td>
            </tr>
          </tbody>
        `;
      }
    }

    load();
  </script>
</body>
</html>
