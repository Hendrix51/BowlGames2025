<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Total Points Grid & Leaderboard</title>
  <style>
    /* ---------- Background (match your other pages) ---------- */
    html { height: 100%; }

    html::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("assets/kick6.webp");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -2;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(246, 247, 251, 0.85);
      z-index: -1;
    }

    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      margin: 0;
      color: #111;
      min-height: 100svh;
      background: transparent;
    }

    @media (max-width: 768px) {
      html::before { background-position: center top; }
    }

    /* ---------- Layout ---------- */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin-bottom: 14px; }
    h1 { margin:0 0 10px; font-size: 22px; }
    .sub { margin: 0 0 12px; opacity: .75; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    a.btn { display:inline-block; padding:8px 12px; border-radius:10px; background:#111; color:#fff; text-decoration:none; font-weight:700; }

    /* ---------- Tables ---------- */
    table { width:100%; border-collapse: collapse; font-size: 12px; }
    th, td {
      border:1px solid #e6e6e6;
      padding:8px;
      vertical-align: middle;
      text-align: center;
    }
    th { position: sticky; top: 0; background: #fff; z-index: 2; }

    .namecol {
      position: sticky;
      left: 0;
      background:#fff;
      z-index:3;
      font-weight:700;
      text-align: left;
      white-space: nowrap;
    }

    .muted { opacity:.7; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Total Points Picks</h1>
          <p class="sub">Everyone’s Total Points predictions by game. Leaderboard = lowest total absolute error once actual totals are entered.</p>
        </div>
        <div class="row">
          <a class="btn" href="index.html">Back to Picks</a>
          <a class="btn" href="leaderboard.html">Spread Leaderboard</a>
        </div>
      </div>
      <div id="status" class="muted">Loading…</div>
    </div>

    <div class="card">
      <h1>Total Points Leaderboard</h1>
      <div id="ouLeaderboard"></div>
    </div>

    <div class="card">
      <h1>Total Points Grid</h1>
      <div id="ouGridStatus" class="muted" style="margin-bottom:10px;"></div>
      <div id="ouGridWrap" style="overflow:auto; display:none;">
        <table id="grid"></table>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDZv4jHUdu7t7crWX4-3GToFzvHKofDSfNANUrVyGCs0Igb3HPYWw8liHOEoIZGHKmnA/exec";

    // ✅ Only games that matter (your list)
    const GAMES = [
      { id: "cotton-bowl-2025-12-31", date: "Dec 31, 2025", bowl: "Cotton Bowl",
        team1: "Miami (FL)", team2: "Ohio State", spread1: "+10", spread2: "-10", ouLine: "" },

      { id: "orange-bowl-2026-01-01", date: "Jan 1, 2026", bowl: "Orange Bowl",
        team1: "Oregon", team2: "Texas Tech", spread1: "-1.5", spread2: "+1.5", ouLine: "" },

      { id: "rose-bowl-2026-01-01", date: "Jan 1, 2026", bowl: "Rose Bowl",
        team1: "Alabama", team2: "Indiana", spread1: "+7", spread2: "-7", ouLine: "" },

      { id: "sugar-bowl-2026-01-01", date: "Jan 1, 2026", bowl: "Sugar Bowl",
        team1: "Ole Miss", team2: "UGA", spread1: "+7", spread2: "-7", ouLine: "" },

      { id: "fiesta-bowl-2026-01-08", date: "Jan 8, 2026", bowl: "Fiesta Bowl",
        team1: "Miami (FL)", team2: "Ole Miss", spread1: "-3.5", spread2: "+3.5", ouLine: "" }, 
        
      { id: "peach-bowl-2026-01-09", date: "Jan 9, 2026", bowl: "Peach Bowl",
        team1: "Oregon", team2: "Indiana", spread1: "+4", spread2: "-4", ouLine: "" }

  
    ];

    const GAME_META = Object.fromEntries(GAMES.map(g => [g.id, g]));
    const GAME_MATCHUP = Object.fromEntries(GAMES.map(g => [g.id, `${g.team1} vs ${g.team2}`]));

    const elStatus = document.getElementById("status");
    const elGrid = document.getElementById("grid");
    const elLb = document.getElementById("ouLeaderboard");
    const elGridWrap = document.getElementById("ouGridWrap");
    const elGridStatus = document.getElementById("ouGridStatus");

    // ✅ LOCK UNTIL: Dec 31, 2025 7:00 PM ET
    const UNLOCK_AT_ET = new Date("2025-12-31T19:00:00-05:00").getTime();
    const UNLOCKED = () => Date.now() >= UNLOCK_AT_ET;

        // ✅ Hide the “last 2” games until a DIFFERENT time (example: Dec 31, 2025 7:30 PM ET)
    const FINAL2_REVEAL_AT_ET = new Date("2026-01-08T19:30:00-05:00").getTime();

    // Put the IDs of the games you want hidden until FINAL4_REVEAL_AT_ET
    const FINAL2_GAME_IDS = new Set([
      "fiesta-bowl-2026-01-08",
      "peach-bowl-2026-01-09",
    ]);

    function isGameRevealed(gid) {
      if (!FINAL2_GAME_IDS.has(String(gid))) return true;
      return Date.now() >= FINAL2_REVEAL_AT_ET;
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function fmtNum(x) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      return Number.isFinite(n) ? (Math.round(n * 10) / 10).toString() : "";
    }

    function formatUnlockTime_() {
      return new Date(UNLOCK_AT_ET).toLocaleString("en-US", {
        timeZone: "America/New_York",
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit"
      }) + " ET";
    }

    function applyLockedUI_() {
      const msg = `Total Points leaderboard + grid will unlock at ${formatUnlockTime_()}.`;
      elStatus.textContent = msg;

      // Hide grid + show message
      elGridStatus.textContent = msg;
      elGridWrap.style.display = "none";
      elGrid.innerHTML = "";

      // Replace leaderboard with message too
      elLb.innerHTML = `<div class="muted" style="text-align:left;">${escapeHtml(msg)}</div>`;
    }

    async function loadUnlocked_() {
      // show grid area
      elGridStatus.textContent = "";
      elGridWrap.style.display = "";

      const [gridRes, lbRes] = await Promise.all([
        fetch(SCRIPT_URL + "?action=ou_grid", { method: "GET" }),
        fetch(SCRIPT_URL + "?action=ou_leaderboard", { method: "GET" })
      ]);

      const gridData = await gridRes.json();
      const lbData = await lbRes.json();

      if (!gridData.ok) throw new Error(gridData.error || "Failed to load Total Points grid");
      if (!lbData.ok) throw new Error(lbData.error || "Failed to load Total Points leaderboard");

      const gameIds = GAMES.map(g => g.id);
      const totals = gridData.totals || {};
      const hasResults = Object.keys(totals).some(k => gameIds.includes(k));

      elStatus.textContent = hasResults
        ? "Results detected — leaderboard uses total absolute error."
        : "No results entered yet — add actual totals in the OU_Results tab to populate leaderboard.";

      renderLeaderboard(lbData.rows || []);
      renderGrid(gameIds, gridData.users || [], gridData.userOUPicks || {}, totals);
    }

    function renderLeaderboard(rows) {
      if (!rows.length) {
        elLb.innerHTML = `<div class="muted" style="text-align:left;">No leaderboard yet (results not entered).</div>`;
        return;
      }

      elLb.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Total Error</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, i) => `
              <tr>
                <td>${i + 1}</td>
                <td><strong>${escapeHtml(r.name)}</strong></td>
                <td>${escapeHtml(fmtNum(r.totalError))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderGrid(gameIds, users, userOUPicks, totals) {
      const thead = `
        <thead>
          <tr>
            <th class="namecol">Name</th>
            ${gameIds.map(gid => {
              const g = GAME_META[gid];
              const actual = Object.prototype.hasOwnProperty.call(totals, gid) ? totals[gid] : undefined;

              const actualTxt = (actual !== undefined)
                ? `<div class="muted">Actual: ${escapeHtml(fmtNum(actual))}</div>`
                : `<div class="muted">Actual: —</div>`;

              return `
                <th>
                  <div><strong>${escapeHtml(GAME_MATCHUP[gid] || gid)}</strong></div>
                  <div class="muted">${escapeHtml(g ? g.bowl : "")}</div>
                  ${actualTxt}
                </th>
              `;
            }).join("")}
          </tr>
        </thead>
      `;

      const tbody = `
        <tbody>
          ${(users.length ? users : []).map(name => {
            const picksObj = userOUPicks && userOUPicks[name] ? userOUPicks[name] : {};
            return `
              <tr>
                <td class="namecol">${escapeHtml(name)}</td>
                ${gameIds.map(gid => {
                  const pick = picksObj ? picksObj[gid] : undefined;
                  const actual = Object.prototype.hasOwnProperty.call(totals, gid) ? totals[gid] : undefined;

                  let extra = "";
                  if (actual !== undefined && pick !== undefined && pick !== null && pick !== "") {
                    const diff = Math.abs(Number(pick) - Number(actual));
                    if (Number.isFinite(diff)) extra = `<div class="muted">Δ ${escapeHtml(fmtNum(diff))}</div>`;
                  }

                  return `
                    <td>
                      <div><strong>${escapeHtml(fmtNum(pick))}</strong></div>
                      ${extra}
                    </td>
                  `;
                }).join("")}
              </tr>
            `;
          }).join("")}
        </tbody>
      `;

      elGrid.innerHTML = thead + tbody;

      if (!users.length) {
        elGrid.innerHTML = thead + `
          <tbody>
            <tr>
              <td class="namecol muted">—</td>
              ${gameIds.map(() => `<td class="muted">No submissions yet</td>`).join("")}
            </tr>
          </tbody>
        `;
      }
    }

    async function boot() {
      if (!UNLOCKED()) {
        applyLockedUI_();

        // Optional: auto-check unlock every 30s so you don't have to refresh right at 7pm
        const timer = setInterval(() => {
          if (UNLOCKED()) {
            clearInterval(timer);
            boot();
          }
        }, 30000);

        return;
      }

      try {
        await loadUnlocked_();
      } catch (e) {
        elStatus.textContent = "Error: " + e.message;
      }
    }

    boot();
  </script>
</body>
</html>
